{% extends 'base.html' %}
{% load static %}

{% block title %}Accept Payment - My Project{% endblock %}

{% block content %}
<div class="min-h-screen bg-white">
    <div class="container mx-auto px-4 py-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-blue-600 mb-4 sm:mb-6 text-center">Accept NFC Card Payment</h1>
        
        <div class="max-w-lg mx-auto">
            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Payment Instructions</h2>
                <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-4">
                    <li>Enter the payment amount below</li>
                    <li>Enter the card ID</li>
                    <li>Click "Process Payment" to complete the transaction</li>
                </ol>
                <p class="text-sm text-gray-500">Note: The amount will be deducted from the card balance.</p>
            </div>
            
            <div class="bg-blue-50 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Payment Details</h2>
                
                <form id="payment-form">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="id_amount" class="block text-gray-700 font-medium mb-2">Amount (₹)</label>
                        <input type="number" id="id_amount" name="amount" step="0.01" min="0.01" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="id_card_id" class="block text-gray-700 font-medium mb-2">Card ID</label>
                        <input type="text" id="id_card_id" name="card_id" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="id_notes" class="block text-gray-700 font-medium mb-2">Notes (Optional)</label>
                        <textarea id="id_notes" name="notes" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Optional notes about this transaction"></textarea>
                    </div>
                    
                    <div class="flex justify-between items-center mt-6">
                        <a href="{% url 'dashboard' %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors duration-200">
                            Cancel
                        </a>
                        <button type="button" id="process-payment-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200">
                            Process Payment
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Payment Result Container (hidden initially) -->
            <div id="payment-result-container" class="bg-blue-50 p-6 rounded-lg shadow-md mt-6 hidden">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Payment Result</h2>
                <div id="payment-result" class="space-y-2">
                    <!-- Payment result will be displayed here -->
                </div>
                <div class="flex justify-between items-center mt-6">
                    <a href="{% url 'payment' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        New Payment
                    </a>
                    <a href="{% url 'dashboard' %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors duration-200">
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const paymentForm = document.getElementById('payment-form');
        const processPaymentBtn = document.getElementById('process-payment-btn');
        const paymentResultContainer = document.getElementById('payment-result-container');
        const paymentResult = document.getElementById('payment-result');
        
        // Handle process payment button click
        processPaymentBtn.addEventListener('click', function() {
            const amountInput = document.getElementById('id_amount');
            const cardIdInput = document.getElementById('id_card_id');
            const notesInput = document.getElementById('id_notes');
            
            const amount = parseFloat(amountInput.value);
            const cardId = cardIdInput.value.trim();
            const notes = notesInput.value;
            
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount greater than 0.');
                return;
            }
            
            if (!cardId) {
                alert('Please enter a valid Card ID.');
                return;
            }
            
            // Show loading state
            paymentResult.innerHTML = '<p class="text-blue-600">Processing payment...</p>';
            paymentResultContainer.classList.remove('hidden');
            
            // Send payment request to server
            fetch('/api/nfc/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    action: 'payment',
                    card_id: cardId,
                    amount: amount,
                    notes: notes
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Payment failed');
                    });
                }
                return response.json();
            })
            .then(response => {
                // Show success message
                paymentResult.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                        <p class="font-bold">Payment Successful!</p>
                        <p>Amount: ₹${response.amount}</p>
                        <p>Card ID: ${response.card_id}</p>
                        <p>Previous Balance: ₹${response.previous_balance}</p>
                        <p>New Balance: ₹${response.new_balance}</p>
                        <p>Transaction ID: ${response.transaction_id}</p>
                        <p>Time: ${new Date(response.timestamp).toLocaleString()}</p>
                    </div>
                `;
                
                // Play success sound
                playSound('success');
            })
            .catch(error => {
                // Show error message
                paymentResult.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <p class="font-bold">Payment Failed</p>
                        <p>${error.message || 'An error occurred while processing the payment.'}</p>
                    </div>
                `;
                
                // Play error sound
                playSound('error');
            });
        });
        
        // Get CSRF token from cookie
        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            
            return cookieValue;
        }
        
        // Play sound
        function playSound(type) {
            const audio = new Audio();
            
            switch (type) {
                case 'success':
                    audio.src = '/static/core/sounds/beep.mp3';
                    break;
                case 'error':
                    audio.src = '/static/core/sounds/beep.mp3';
                    break;
                default:
                    audio.src = '/static/core/sounds/beep.mp3';
            }
            
            audio.play().catch(error => {
                console.warn('Could not play sound:', error);
            });
        }
    });
</script>
{% endblock %}

