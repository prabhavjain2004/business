{% extends 'base.html' %}

{% block title %}Accept Payment - My Project{% endblock %}

{% block content %}
<div class="min-h-screen bg-white">
    <div class="container mx-auto px-4 py-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-blue-600 mb-4 sm:mb-6 text-center">Accept NFC Card Payment</h1>
        
        <div class="max-w-lg mx-auto">
            <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Payment Instructions</h2>
                <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-4">
                    <li>Enter the payment amount below</li>
                    <li>Click "Prepare Payment" to continue</li>
                    <li>Scan the customer's NFC card when prompted</li>
                    <li>Confirm the payment details</li>
                </ol>
                <p class="text-sm text-gray-500">Note: Make sure the NFC reader is active before scanning the card.</p>
            </div>
            
            <div class="bg-blue-50 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Payment Details</h2>
                
                <form method="post" id="payment-form">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="id_amount" class="block text-gray-700 font-medium mb-2">Amount (₹)</label>
                        {{ form.amount }}
                        {% if form.amount.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.amount.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        <label for="id_notes" class="block text-gray-700 font-medium mb-2">Notes (Optional)</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.notes.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="flex justify-between items-center mt-6">
                        <a href="{% url 'dashboard' %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors duration-200">
                            Cancel
                        </a>
                        <button type="button" id="prepare-payment-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200">
                            Prepare Payment
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- NFC Reader Container (hidden initially) -->
            <div id="nfc-reader-container" class="bg-blue-50 p-6 rounded-lg shadow-md mt-6 hidden">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Scan NFC Card</h2>
                <div id="nfc-reader"></div>
            </div>
            
            <!-- Payment Result Container (hidden initially) -->
            <div id="payment-result-container" class="bg-blue-50 p-6 rounded-lg shadow-md mt-6 hidden">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Payment Result</h2>
                <div id="payment-result" class="space-y-2">
                    <!-- Payment result will be displayed here -->
                </div>
                <div class="flex justify-between items-center mt-6">
                    <a href="{% url 'payment' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        New Payment
                    </a>
                    <a href="{% url 'dashboard' %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors duration-200">
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const paymentForm = document.getElementById('payment-form');
        const preparePaymentBtn = document.getElementById('prepare-payment-btn');
        const nfcReaderContainer = document.getElementById('nfc-reader-container');
        const paymentResultContainer = document.getElementById('payment-result-container');
        const paymentResult = document.getElementById('payment-result');
        
        // Initialize NFC reader when the page loads
        if (typeof NFCReader !== 'undefined' && typeof NFCCardManager !== 'undefined') {
            const nfcReader = new NFCReader({
                onReading: handleCardReading,
                onError: handleError,
                onSuccess: handleSuccess,
                onNotSupported: handleNotSupported
            });
            
            const cardManager = new NFCCardManager('/api/nfc/');
            
            // Initialize UI handler
            const uiHandler = new NFCUIHandler('nfc-reader', nfcReader, cardManager);
            
            // Store references for later use
            window.paymentNfcReader = nfcReader;
            window.paymentCardManager = cardManager;
            window.paymentUiHandler = uiHandler;
        }
        
        // Handle prepare payment button click
        preparePaymentBtn.addEventListener('click', function() {
            const amountInput = document.getElementById('id_amount');
            const amount = parseFloat(amountInput.value);
            
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount greater than 0.');
                return;
            }
            
            // Show NFC reader
            nfcReaderContainer.classList.remove('hidden');
            
            // Scroll to NFC reader
            nfcReaderContainer.scrollIntoView({ behavior: 'smooth' });
        });
        
        // Handle card reading
        function handleCardReading(cardData) {
            const amountInput = document.getElementById('id_amount');
            const notesInput = document.getElementById('id_notes');
            const amount = parseFloat(amountInput.value);
            const notes = notesInput.value;
            
            // Process payment
            processPayment(cardData, amount, notes);
        }
        
        // Process payment
        function processPayment(cardData, amount, notes) {
            // Show loading state
            paymentResult.innerHTML = '<p class="text-blue-600">Processing payment...</p>';
            paymentResultContainer.classList.remove('hidden');
            
            // Send payment request to server
            window.paymentCardManager.sendCardData(cardData, 'payment', {
                amount: amount,
                notes: notes
            })
            .then(response => {
                // Show success message
                paymentResult.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                        <p class="font-bold">Payment Successful!</p>
                        <p>Amount: ₹${response.amount}</p>
                        <p>Card ID: ${response.card_id}</p>
                        <p>Previous Balance: ₹${response.previous_balance}</p>
                        <p>New Balance: ₹${response.new_balance}</p>
                        <p>Transaction ID: ${response.transaction_id}</p>
                        <p>Time: ${new Date(response.timestamp).toLocaleString()}</p>
                    </div>
                `;
                
                // Hide NFC reader
                nfcReaderContainer.classList.add('hidden');
                
                // Play success sound
                playSound('success');
            })
            .catch(error => {
                // Show error message
                paymentResult.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <p class="font-bold">Payment Failed</p>
                        <p>${error.message || 'An error occurred while processing the payment.'}</p>
                    </div>
                `;
                
                // Play error sound
                playSound('error');
            });
        }
        
        // Handle error
        function handleError(error) {
            console.error('NFC Error:', error);
        }
        
        // Handle success
        function handleSuccess(message) {
            console.log('NFC Success:', message);
        }
        
        // Handle not supported
        function handleNotSupported() {
            console.warn('NFC not supported');
            
            // Show message
            const nfcReader = document.getElementById('nfc-reader');
            if (nfcReader) {
                nfcReader.innerHTML = `
                    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                        <p class="font-bold">NFC Not Supported</p>
                        <p>Your browser does not support NFC. Please use a compatible browser or device.</p>
                        <p class="mt-2">You can use the "Simulate Card" button below for testing.</p>
                    </div>
                `;
            }
        }
        
        // Play sound
        function playSound(type) {
            const audio = new Audio();
            
            switch (type) {
                case 'success':
                    audio.src = '/static/core/sounds/beep.mp3';
                    break;
                case 'error':
                    audio.src = '/static/core/sounds/beep.mp3';
                    break;
                default:
                    audio.src = '/static/core/sounds/beep.mp3';
            }
            
            audio.play().catch(error => {
                console.warn('Could not play sound:', error);
            });
        }
    });
</script>
{% endblock %}
