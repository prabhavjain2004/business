{% extends 'base.html' %}
{% load static %}

{% block title %}Issue Card - TapNex{% endblock %}

{% block content %}
<div class="min-h-screen bg-white">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-blue-600 mb-8">Issue New Card</h1>
        <div class="grid grid-cols-1 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div id="issue-card-container">
                    <!-- Step 1: Identify Customer -->
                    <div id="step-1" class="step-container">
                        <h2 class="text-xl font-semibold text-blue-600 mb-4">Step 1: Identify Customer</h2>
                        <p class="text-lg text-center mb-4">Scan the customer's QR code or enter Customer ID</p>
                        <div class="flex flex-col items-center mb-4 gap-4">
                            <button id="scan-qr-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">Scan QR Code</button>
                            <div id="qr-reader" class="w-full max-w-xs hidden"></div>
                            <div class="w-full flex items-center gap-2">
                                <input type="text" id="manual-customer-id" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter Customer ID (Random No.)">
                                <button id="fetch-customer-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors duration-200">Fetch</button>
                            </div>
                        </div>
                        <div id="customer-info" class="hidden bg-gray-100 p-4 rounded-lg mb-4">
                            <p><strong>Name:</strong> <span id="customer-name"></span></p>
                            <p><strong>Mobile:</strong> <span id="customer-mobile"></span></p>
                            <p><strong>Email:</strong> <span id="customer-email"></span></p>
                        </div>
                        <div id="customer-error" class="text-red-600 text-center hidden"></div>
                        <button id="proceed-to-card-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200 mt-4 hidden">Proceed to Card Issue</button>
                    </div>
                    <!-- Step 2: Scan Card -->
                    <div id="step-2" class="step-container hidden">
                        <h2 class="text-xl font-semibold text-blue-600 mb-4">Step 2: Scan Card</h2>
                        <p class="text-lg text-center mb-4">Please tap an NFC card to begin</p>
                        <div class="flex justify-center mb-4">
                            <div class="animate-pulse bg-blue-100 rounded-full p-8">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scanQrBtn = document.getElementById('scan-qr-btn');
    const qrReader = document.getElementById('qr-reader');
    const manualCustomerId = document.getElementById('manual-customer-id');
    const fetchCustomerBtn = document.getElementById('fetch-customer-btn');
    const customerInfo = document.getElementById('customer-info');
    const customerName = document.getElementById('customer-name');
    const customerMobile = document.getElementById('customer-mobile');
    const customerEmail = document.getElementById('customer-email');
    const customerError = document.getElementById('customer-error');
    const proceedToCardBtn = document.getElementById('proceed-to-card-btn');
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');

    let identifiedCustomerId = null;
    let html5QrCode = null;

    function showCustomerInfo(data) {
        customerName.textContent = data.name;
        customerMobile.textContent = data.mobile;
        customerEmail.textContent = data.email;
        customerInfo.classList.remove('hidden');
        customerError.classList.add('hidden');
        proceedToCardBtn.classList.remove('hidden');
    }
    function showCustomerError(msg) {
        customerInfo.classList.add('hidden');
        customerError.textContent = msg;
        customerError.classList.remove('hidden');
        proceedToCardBtn.classList.add('hidden');
    }
    function fetchCustomerDetails(customerId) {
        fetch(`/api/get_customer_details/?customer_id=${encodeURIComponent(customerId)}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showCustomerInfo(data.customer);
                    identifiedCustomerId = customerId;
                } else {
                    showCustomerError(data.error || 'Customer not found');
                }
            })
            .catch(() => showCustomerError('Error fetching customer details'));
    }
    scanQrBtn.addEventListener('click', function() {
        qrReader.classList.remove('hidden');
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("qr-reader");
        }
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 200 },
            qrCodeMessage => {
                html5QrCode.stop();
                qrReader.classList.add('hidden');
                fetchCustomerDetails(qrCodeMessage);
            },
            errorMessage => {}
        );
    });
    fetchCustomerBtn.addEventListener('click', function() {
        const id = manualCustomerId.value.trim();
        if (id) fetchCustomerDetails(id);
    });
    proceedToCardBtn.addEventListener('click', function() {
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
        // You can pass identifiedCustomerId to the backend as needed
    });
});
</script>
{% endblock %}
